language: minimal

services:
  - docker

env:
  global:
    - DOCKER_ORG_NAME=tidair
    - DOCKER_REPO=smurf-base

stages:
  - name: deploy_docker
    if: tag IS present

jobs:
  include:
    - stage: deploy_docker
      name: "Deploy Docker Image"
      before_script:
        # Use the git tag to tag tag docker image
        - export DOCKER_TAG=`git describe --tags --always`
        # Login to docker
        - echo "${DOCKER_PASSWORD}" | docker login -u "${DOCKER_ORG_NAME}" --password-stdin;

      script:
        # Build the docker image
        - docker build -t ${DOCKER_ORG_NAME}/${DOCKER_REPO} .

      after_success:
        # Upload docker image (as tagged and latest version)
        - docker push ${DOCKER_ORG_NAME}/${DOCKER_REPO};
        - docker tag ${DOCKER_ORG_NAME}/${DOCKER_REPO} ${DOCKER_ORG_NAME}/${DOCKER_REPO}:${DOCKER_TAG};
        - docker push ${DOCKER_ORG_NAME}/${DOCKER_REPO}:${DOCKER_TAG};
        - echo "Docker image '${DOCKER_ORG_NAME}/${DOCKER_REPO}:${DOCKER_TAG}' pushed"

notifications:
  slack:
    secure: PUfMpd9K+QD+WfHev3ZUjRL6k/y/vN0rmMPL0Ciy68TZi6Qhzr3ga01cfTfEzAdDit0Z2rJpFCib08sfoPuxj3Ukez1bXDoXq1I35/xz22bfUMhGN2Lhkb/Y3AXLXiibBo2GtRP4ADdhFx8xStTVfTr8hz7w8VkPeajpFrdHCxIR7Zm7bdSgMd1JnHPn/z8334LUc0H/x71Dg5lHbmZgAVBy3a4rsODl5+5wwuL3VbFQK1WdM8EoWcjp7ZdG7zHBoIhB3bfRB6lcxinzoDi36vxGSN9fEGbkg6erjjOXpMy2Tjbw5SUpS+hpp2HQE3hc4tHqSKGQMkQ0CIbhNOzvqWNlkk06LZuNhJRGzgBTi4vUTOxwCC8FmlCOYovpoAZ9f6mypXZXxDJ1b3pucr2h8TogwTPvJXAaTmSWhtSIJhWMqCGCS9PniaQ7WoRID3AaefuxOPe18KXu3s7K3J+RjsMllBiTURyQh0NqHcCVMowuFB+X9Xd8f8/LM6dVyUZiJ3Y26fsH3mHFT3pddN77JRouC9lB05LOX9gB5YlMvLABB5oDAB//GOE/Oi67pURnlKNljzXynWDjuxndOWoxCC1FMCV1XJ52/FVOSt8od7S2FNbR0AjDsR0R+y598lTQ5dymKSIlsp5dBFTnt2loIv6Hn1gMVGQvgf3J7ZBIv9o=
