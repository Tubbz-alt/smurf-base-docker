language: minimal

services:
  - docker

env:
  global:
    - DOCKER_ORG_NAME=tidair
    - DOCKER_REPO=smurf-base

stages:
  - name: deploy_docker
    if: tag IS present

jobs:
  include:
    - stage: deploy_docker
      name: "Deploy Docker Image"
      before_script:
        # Use the git tag to tag tag docker image
        - export DOCKER_TAG=`git describe --tags --always`
        # Login to docker
        - echo "${DOCKER_PASSWORD}" | docker login -u "${DOCKER_ORG_NAME}" --password-stdin;

      script:
        # Build the docker image
        - docker build -t ${DOCKER_ORG_NAME}/${DOCKER_REPO} .

      after_success:
        # Upload docker image (as tagged and latest version)
        - docker push ${DOCKER_ORG_NAME}/${DOCKER_REPO};
        - docker tag ${DOCKER_ORG_NAME}/${DOCKER_REPO} ${DOCKER_ORG_NAME}/${DOCKER_REPO}:${DOCKER_TAG};
        - docker push ${DOCKER_ORG_NAME}/${DOCKER_REPO}:${DOCKER_TAG};
        - echo "Docker image '${DOCKER_ORG_NAME}/${DOCKER_REPO}:${DOCKER_TAG}' pushed"

notifications:
  slack:
    secure: LsV3t3dsylpS/uj7pSb0yBJ1Z0OXZE4/DD8HzriCiMd0OXJGCFxq1pSVb+kwznL26D8IQjUETcF3SbHrv1DjcurselWs2byZrKA2ScgF5jWJatabhdI51s6u3vQxO5kJNqXvioCFGgNJ4Gxf21uu54X+xWxHUo2nsDXlFvoQxjzaoiO8mAnjiSRqB8Iv+69IVtMsaLjUS2+X74/2aRkbIfG2f4CdqU7nnyfKcgsDML1PWTItT0OaExekYnPK5++0DZRnGVT5TaklrPDVV4vje/4uJcb8S2uJEkhDLL2w8WeYWCmvQw1s7jC7A+/VTOs2pZJlouav+C32RVbyQ4rmaDuAzWJWg2nBs+0X3A8zsAv8At/rdCSVhXwBZoEabBz90wqprj/F9sG3jzljG6wWvnyozivgNgI3uijNgd0FWsjWHjky/AuekCu0vpLgZ/Wx3pyD8TPCYQ0K1Xsz9cUGB8W6Oit3rABor1qisRRh7bAkmrhke+C/8BISjyXpiPe49d3d7GvRI9ijOg7myU0YyvJuJ55G4ts+04dGlO4uxSqLvRmIfAjdd1gfSr9jWknmnMcJKrTQTbvbh2DHOmhWwWMP4lX/6sH1q6n24aNkDHtrQijomABpN7BRcTpPkCjw1Vni0aNv69kWKPQtMEPl72Dxx0POPUzAuqWoxDgeYjA=
